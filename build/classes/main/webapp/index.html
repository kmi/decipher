<html>
<head>
<title>RibbitMessagePost</title>
<!-- <script type="text/javascript" src="js/prototype.js"></script> -->
<link rel="stylesheet" type="text/css" media="all" href="css/layout.css" />
<link rel="stylesheet" type="text/css" media="all" href="css/grid.css" />
<script type="text/javascript" src="js/jquery-1.5.2.min.js"></script> 
<script type="text/javascript">

var serviceRequest;
var in_count=0;
var operations;
var sURL,sID,opName,sName;

function createRequest(){

	if (window.XMLHttpRequest)
    {
     // code for IE7+, Firefox, Chrome, Opera, Safari
     serviceRequest=new XMLHttpRequest();
    }
  else if (window.ActiveXObject)
    {
      // code for IE6, IE5
      serviceRequest=new ActiveXObject("Microsoft.XMLHTTP");
     }
  else
     {
       alert("Your browser does not support XMLHTTP!");
     }
}
function requestService()
  {
    createRequest();
    sID=document.getElementById("serviceID").value;  
    sID=sID.replace("#","%23"); 
    var url = "service/ServiceRequest/"+sID; 
//    opName=document.getElementById("opName").value;  
//    var url = "Invoke/ServiceRequest/"+sID+"/" +opName; 
    serviceRequest.open("GET",url,true);	
	serviceRequest.onreadystatechange=displayService;
	serviceRequest.send(null);   
  }
  
function invokeService(address,noOfInpart)
{ 
 // var url = "Invoke/ServiceInvoker?";
 // var queryStr="address=" + address;
 var url = "service/ServiceInvoke/"+sID+"/" +opName; 
 var queryStr="sURL="+ sURL + "&sID="+ sID;
  
  for (var i=1;i<=noOfInpart;i++)
	  if(document.getElementById("inPart".concat(i)).value!="")
	  queryStr +="&"+ document.getElementById("inPart".concat(i).concat("_label")).innerHTML + "=" + document.getElementById("inPart".concat(i)).value;
  serviceRequest.open("GET",url+queryStr,true);	
  serviceRequest.onreadystatechange=displayResult;
  serviceRequest.send(null);    
}

function invokeOperation(noOfInpart)
{   
	 var url = "service/ServiceExecute/"+sID+"/" +opName; 
	 var queryStr="";
     for (var i=1;i<=noOfInpart;i++)
     {
       if(document.getElementById("inPart".concat(i)).value!="")
         if(i==1)
       	  queryStr +="?"+ encodeURIComponent(document.getElementById("inPart".concat(i).concat("_mod_ref_options")).options[document.getElementById("inPart".concat(i).concat("_mod_ref_options")).value].text) + "=" + document.getElementById("inPart".concat(i)).value;
         else 	 
    	  queryStr +="&"+ encodeURIComponent(document.getElementById("inPart".concat(i).concat("_mod_ref_options")).options[document.getElementById("inPart".concat(i).concat("_mod_ref_options")).value].text) + "=" + document.getElementById("inPart".concat(i)).value;
     }      
    serviceRequest.open("GET",url+queryStr,true);	
    serviceRequest.onreadystatechange=displayResult;
    serviceRequest.send(null);    
}
 
 function displayResult()
  { 
	 if (serviceRequest.readyState == 4 & serviceRequest.status == 200) 
		{ 		  
		  var textDoc = serviceRequest.responseText;
		  var xmlDoc = serviceRequest.responseXML;

		  document.getElementById("allDiv").innerHTML = textDoc;  
//	      document.write(textDoc);	  
/*	      $(xmlDoc).find("rdf:RDF").each(function()
	    		  {
	    		    $("#allDiv").append($(this).find("estate:Property").text());
	    		  });
*/
	   	  /*
		  var uri = serviceRequest.getAllResponseHeaders();
		  alert(uri.substring(uri.indexOf("Location:")+"Location:".length));
		  var body = serviceRequest.responseText;
		  alert(body);	
		  window.location = uri.substring(uri.indexOf("Location:")+ "Location:".length);	
		*/
		}
	  else if (serviceRequest.status == 400)
		 {
		  outputText = "Bad request. This operation is not available from this service, please check operation name";
		  document.getElementById("allDisplay").innerHTML = outputText;    
		 }
	  else if (serviceRequest.status == 500)
		 {
		  outputText = "No response from the original service";
		  document.getElementById("allDisplay").innerHTML = outputText;    
		 }	
   }

  function displayService()
  { 
	  var outputText='';
	//  alert("readyState: " + serviceRequest.readyState);
	//  alert("Status: " + serviceRequest.status);
	  
	//  document.getElementById("initialInfo").style.display="none";
	  if (serviceRequest.readyState == 4 & serviceRequest.status == 200) 
		{ 
		  var uri = serviceRequest.getAllResponseHeaders();
	//	  alert(uri.substring(uri.indexOf("Location:")+"Location:".length));
	//	  window.location.hash = uri.substring(uri.indexOf("Location:")+ "Location:".length);	

		  var body = serviceRequest.responseXML;
		  var service = body.getElementsByTagName("service")
		  var sUri = service[0].firstChild.nodeValue;
		  var sLabel = sUri.substring(sUri.indexOf("#")+1);
		  sName = sLabel;
		  document.getElementById("title").innerHTML = sLabel;    
     
		  operations = body.getElementsByTagName("operation");
	      for (var i=0;i<operations.length;i++)
		   {
	        var operation = operations[i];
	    	var opuri=operation.firstChild.nodeValue;
	        var opname=opuri.substring(opuri.indexOf("#")+1);
	        outputText += '<a href="#" onclick="getOperation(\''+ i +'\')">' + opname + '</a>';
	        }
	       document.getElementById("allDiv").innerHTML = outputText;    

		}
	  else if (serviceRequest.status == 400)
		 {
		  outputText = "Bad request. Maybe wrong service ID.";
		  document.getElementById("allDisplay").innerHTML = outputText;    
		 }
   }
  
  function getOperation(index){
	  var inPartCounter=0;
	  var operation=operations[index];
	  
	  opName=operation.firstChild.nodeValue.substring(operation.firstChild.nodeValue.indexOf("#")+1);
 	 
	  document.getElementById("title").innerHTML = operation.firstChild.nodeValue.substring(operation.firstChild.nodeValue.indexOf("#")+1); 				
	  var outputText="<table>";
		
	  var opChilds=operation.childNodes;
	  for (var i=1;i<opChilds.length;i++)
      { var opChild =opChilds[i];
        if (opChild.nodeName=="address") 
        {
        	  address=opChild.firstChild.nodeValue;
      //  	  alert(address);
        }
        else if	(opChild.nodeName=="method") 
        {
          	  method= opChild.firstChild.nodeValue;
        //  	  alert(method);
        }
        else if	(opChild.nodeName=="input") 
        {   //input=opChild.firstChild.nodeValue;
  	        outputText+='<td><label><b>Input Name</b></label></td>'+'<td><label><b>Value</b></label></td>'+'<td><label><b>ModelReferences</b></label></td>';          	           
  	       
             inChilds=opChild.childNodes;
        	  for (var j=1;j<inChilds.length;j++)
        	   { var inChild =inChilds[j];
        	    
        	     if(inChild.nodeName=="part") 
        	      {   
        	        outputText+='<tr>';
        	        part = inChild.firstChild.nodeValue;
        	 //       alert(part);
        	        inID ="inPart".concat(++inPartCounter);
        	        var old_inID = null;
        	        var mf_counter=0;
        	        var mf_output='';
        	        outputText+='<td><label for="'+inID +'" id="'+inID+'_label">'+ part.substring(part.indexOf("#")+1) + '</label></td><td><input id="'+inID+'" type="text" size="30" value=""/></td>';          	           
        	        partChilds=inChild.childNodes;
        	         for (var m=1;m<partChilds.length;m++)
        	        	 { 
        	        	    var partChild =partChilds[m];
        	        	        if(partChild.nodeName=="example" && partChild.firstChild!= null)         	        	
        	        	         if (partChild.firstChild.nodeValue!= null) 	        	         	        	        	  
        	        	          {	var example = partChild.firstChild.nodeValue;
        	        	            outputText+='<td>'+ example +'</td>';
        	        	          }
        	        	        if(partChild.nodeName=="modelReference" && partChild.firstChild!= null)         	        	
           	        	         if (partChild.firstChild.nodeValue!= null) 	        	         	        	        	  
           	        	          {	var mod_ref = partChild.firstChild.nodeValue;    	        	
           	        	        	if(inID != old_inID)
           	        	             { 
           	        	        	   mf_output += '<td><select id="'+ inID +'_mod_ref_options" name="'+ inID +'_mod_ref_options">';
           	        	               mf_output += '<option value="'+ (mf_counter++) + '">' + mod_ref + '</option></select></td>';
           	        	             } 
           	        	            else
           	        	             {        
           	        	            	mf_output = mf_output.replace('</select></td>', '<option value="'+ (mf_counter++) + '">' + mod_ref + '</option></select></td>');                      	        	                	        	            	
           	        	             }
             	        	        // outputText+='<td>'+ mod_ref +'</td>';
             	        	        old_inID = inID;
           	        	          }
        	        	      } 
        	            outputText+= mf_output + '</tr>';
         	         }
        	      }
        	      
          	}
        	else if	(opChild.nodeName=="output") 
        	{
     //     	  addr= opChild.firstChild.nodeValue;
          	}
        
      }
	  outputText+="</table>"; 
 //	  outputText+= '<input type="button" value="Invoke Service" onclick="invokeService(\''+ address + '\',\'' + inPartCounter +'\')" />';  
 	  outputText+= '<input type="button" value="Invoke Operation" onclick="invokeOperation(\''+ inPartCounter +'\')" />';  
 //	  outputText+= '<input type="button" value="Operation Invocation History" onclick="getServiceInvocation()" />';  
 	  document.getElementById("allDiv").innerHTML = outputText; 				
  }
  function getServiceInvocation()
  {
	    createRequest();
	    alert(sID);
	    alert(opName);
	    
	    var url = "service/"+sID+"/operation/" +opName+ "data"; 
	 //   alert(url);
	    serviceRequest.open("GET",url,true);	
		serviceRequest.onreadystatechange=displayResult;
		serviceRequest.send(null);   

  }
  function getOperationInvocation()
  {
	    createRequest();
	    alert(sName);
	    alert(opName);
	    var url = "Invoke/OperationInvocation/"+ sName + "/" + opName; 
	    serviceRequest.open("GET",url,true);	
		serviceRequest.onreadystatechange=displayResult;
		serviceRequest.send(null);   
  }
</script>
</head>

<body>
<div id = "allDisplay">
<h1><div id="title">Service Invocation Demo Page</div></h1> 
<form>
  <div id="allDiv">
  
  </br>
  <p>To invoke a particular service, the service description UID registered with iServe is required. If you don't know the UID, please obtain it
through the <a href="http://iserve.kmi.open.ac.uk/browser.html"><b>iServe Brower</b></a> searching facility or through the service <a href="http://iserve.kmi.open.ac.uk/wiki/index.php/IServe_Higher_Level_Discovery_API"><b>Discovery API</b></a> </p>
   <br> 
   <div id="initialInfo" style="display: block">
   <table><tr>       
     <td><label for="serviceID"  style="width:300px"><b>iServe ServiceID:</b></label></td>
<!-- <td><input id="serviceID" type="text" name="serviceID"  size="150" value="54cf2ab4-38f0-4cea-9c18-4142f8f453a8"/></td>  
     <td><input id="serviceID" type="text" name="serviceID"  size="150" value="54cf2ab4-38f0-4cea-9c18-4142f8f453a1"/></td>  -->  
<!-- Nestoria on iServe -->
     <td><input id="serviceID" type="text" name="serviceID"  size="150" value="e8f9548e-bbed-43fe-9d8a-71b7fdefb9da"/></td> 
  
   </tr>
   <!-- <tr>   
     <td><label for="opName"  style="width:300px"><b>Operation Name:</b></label></td>
     <td><input id="opName" type="text" name="opName"  size="150" value="SearchListingsOperation"/></td>
     <td><input id="opName" type="text" name="opName"  size="150" value="RibbitSMSOperation"/></td>   
   </tr> -->
   </table>
  </div>
  <div id="displayDiv">
      <input type="button" value="Request Service" onclick="requestService()" />       
<!--  <input type="button" value="Service Invocation History" onclick="getServiceInvocation()" /> --> 
  </div>
  </div>
 </form>
 </div>
</body>
</html>
